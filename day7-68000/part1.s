    section text

start:
    move.l  #0,d7            ; d7 = score
    move.w  #141,largeur
    move.w  #141,hauteur     ; initialise la hauteur
    move.w  #0,d4            ; colonne en cours (index 0)
    move.w  #0,d5            ; ligne en cours (index 0)


cherches:
    lea     tableau,a0
    move.b  0(a0,d4.w),d1    ; chargement du caractere a la position en cours
    cmp.b   #83,d1           ; Si c'est S 
    beq     trouves
    add.w   #1,d4            ; sinon on incremente
    cmp     largeur,d4       ; si on depasse
    bge     fin              ; c'est qu'on a pas trouve de S
    bra     cherches         ; sinon on boucle

trouves:
    pea     aff_s(pc)       ; Affichage Position S
    move.w  #9,-(sp)      
    trap    #1
    addq.l  #6,sp    

    move.l  d4,d0
    bsr     print_num

    pea     msg_crlf(pc)
    move.w  #9,-(sp)
    trap    #1
    addq.l  #6,sp

    ; Place les barres sur la ligne SUIVANT le S
    move.w  d5,d0
    add.w   #1,d0           ; ligne suivante = d5 + 1
    mulu.w  largeur,d0
    add.w   d4,d0           ; d0=(y+1)*largeur+x
    lea     tableau,a0
    move.b  0(a0,d0.w),d1   ; chargement du caractere dans d1
    cmp.b   #94,d1          ; si ^
    bne     metbarredirect
    ; Si c'est ^, place 2 barres à gauche et droite
    move.w  d4,d2
    sub.w   #1,d2           ; colonne - 1
    move.w  d5,d3
    add.w   #1,d3           ; ligne suivante
    mulu.w  largeur,d3
    add.w   d2,d3
    move.b  #124,(a0,d3.w)

    move.w  d4,d2
    add.w   #1,d2           ; colonne + 1
    move.w  d5,d3
    add.w   #1,d3           ; ligne suivante
    mulu.w  largeur,d3
    add.w   d2,d3
    move.b  #124,(a0,d3.w)
    add.w   #1,d7
    bra     loop_y

metbarredirect:
    move.b  #124,(a0,d0.w)
 


loop_y:
    add.w #1,d5
    cmp   hauteur,d5
    bge   aff_result      ; si d5 >= hauteur, on a fini
    move.w  #0,d4          ; réinitialise la colonne à 0 

loop_x:    
    move.w  d5,d0        ; on met la ligne en cours dans d0
    mulu.w  largeur,d0   
    add.w   d4,d0 
    lea     tableau,a0
    move.b  0(a0,d0.w),d1   ; chargement du caractere dans d1
    cmp.b   #124,d1
    bne     fin_loopx
    move.w  d5,d0        ; on met la ligne suivante dans d0
    add.w   #1,d0
    mulu.w  largeur,d0   
    add.w   d4,d0 
    lea     tableau,a0
    move.b  0(a0,d0.w),d1   ; chargement du caractere dans d1    
    cmp.b   #94,d1          ; si c'est pas ^
    bne     metbarredessous ;
    move.w  d4,d2           ; sinon on met 2 barres lignes suivante
    sub.w   #1,d2
    move.w  d5,d3        
    add.w   #1,d3
    mulu.w  largeur,d3
    add.w   d2,d3
    move.b  #124,(a0,d3.w)      
    move.w  d4,d2
    add.w   #1,d2
    move.w  d5,d3  
    add.w   #1,d3         
    mulu.w  largeur,d3
    add.w   d2,d3
    move.b  #124,(a0,d3.w) 
    add.w   #1,d7           ; et on incremente le score
    bra     fin_loopx

metbarredessous:
    move.b  #124,(a0,d0.w)

fin_loopx:
    add.w   #1,d4
    cmp     largeur,d4
    bge     loop_y
    bra     loop_x

aff_result:

    lea     tableau,a0          
    move.w  #40,d2            ; compteur de lignes (40 lignes suffisent a voir si l algorithme est correct)

.boucle_lignes:
    lea     charbuf,a1
    move.w  #140,d6           

.copie_ligne:
    move.b  (a0)+,(a1)+        ; copie octet par octet
    dbf     d6,.copie_ligne

    clr.b   (a1)               ; met le  0 à la fin

    movem.l d0-d7/a0-a6,-(sp)

    pea     charbuf
    move.w  #9,-(sp)
    trap    #1
    addq.l  #6,sp

    pea     msg_crlf(pc)
    move.w  #9,-(sp)
    trap    #1
    addq.l  #6,sp


    movem.l (sp)+,d0-d7/a0-a6

    dbf     d2,.boucle_lignes

    movem.l d0-d3/a0-a1,-(sp)
    pea     msg_score(pc)
    move.w  #9,-(sp)
    trap    #1
    addq.l  #6,sp
    movem.l (sp)+,d0-d3/a0-a1

    move.w  d7,d0
    bsr     print_num

    pea     msg_crlf(pc)
    move.w  #9,-(sp)
    trap    #1
    addq.l  #6,sp

    move.w  #1,-(sp)        ; Attente appui touche
    trap    #1
    addq.l  #2,sp

fin:
    clr.w   -(sp)
    trap    #1              ; hasta la vista bye bye   



print_num:
        movem.l d0-d3/a0-a1,-(sp) ; sauvegarde des registres sur la pile
        
        tst.l   d0                      ; si d0 = 0 on affiche 0
        bne     .not_zero              
        lea     numbuf,a0
        move.b  #48,(a0)+
        clr.b   (a0)
        pea     numbuf
        move.w  #9,-(sp)
        trap    #1
        addq.l  #6,sp
        bra     .fini
        
.not_zero:                      ; sinon
        lea     numbuf+11,a0
        clr.b   (a0)
        move.l  d0,d1

.conv_loop:

        moveq   #0,d2           
        move.l  d1,d3           
        divu.w  #10,d3        ; division par 10 
        move.w  d3,d1           ; on met le quotient dans d1 
        clr.w   d3              ; on efface les 16 bits bas
        swap    d3              ; on met le reste de la division (16bis hauts) dans les 16 bits bas
        
        add.b   #48,d3          ; convertion du chiffre en ascii (48+d3) et stockage
        move.b  d3,-(a0)       
        
        tst.l   d1              ; teste si quotient different de 0 alors on a encore des chiffres a traiter
        bne     .conv_loop

        move.l  a0,-(sp)        ; on affiche le chiffre
        move.w  #9,-(sp)
        trap    #1
        addq.l  #6,sp

.fini:
        movem.l (sp)+,d0-d3/a0-a1 ; restore les registes
        rts

    section bss

largeur:
   ds.w  1    

hauteur:
   ds.w  1    



    section data
msg_crlf:
        dc.b    13,10,0     ; retour chariot

aff_s:
        dc.b    'Colonne S : ',0

msg_score:
        dc.b    'Score : ',0

numbuf:
        ds.b    12     ; Buffer 12 octets pour conversion nombre

charbuf:
        ds.b    142    ; Buffer pour 1 ligne (141 caractères + terminateur 0)

tableau:
   dc.b  '......................................................................S......................................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '......................................................................^......................................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.....................................................................^.^.....................................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '....................................................................^.^.^....................................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...................................................................^...^.^...................................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '..................................................................^.^.....^..................................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.................................................................^.^...^.^.^.................................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '................................................................^...^.^.^.^.^................................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...............................................................^.^...^.....^.^...............................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '..............................................................^.^.^.^.^...^.^.^..............................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.............................................................^...^.^...^.......^.............................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '............................................................^.^.^.^.^.^...^.^.^.^............................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...........................................................^.^.^.^.^.^...^.^...^.^...........................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '..........................................................^.......^...^.^.^.^.^.^.^..........................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.........................................................^...^...^.....^...^.......^.........................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '........................................................^...^.^.^.^.^...^.^.^.^.^...^........................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.......................................................^.....^.....^.^.....^.^.^.^...^.......................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '......................................................^.^.^.....^.^.^...^...^...^...^.^......................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.....................................................^.^.^.^.^...^.^.....^.^.^.^.^.^.^.^.....................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '....................................................^.^.^.^.....^.^.^.....^.^.^...^.^.^.^....................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...................................................^...^...^...^.^...^.^.^.^.^.^.^.^...^.^...................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '..................................................^.^...^.^.^.^...^.^.^...^...^.^...^.^...^..................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.................................................^.^.^.^.^.^.....^...^.^.^.^.^.^...^...^.^.^.................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '................................................^.^.^.....^.........^.^...^.^.....^.^.^.^.^.^................................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...............................................^...^.^.^.^.^.^...^...^...^.^.^.^.^.....^.^...^...............................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '..............................................^.^.^.^...^.^...^.....^.^...^.^...^...^.....^.^.^..............................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.............................................^.^...^...^.^.^.^.^.^...^...^.^...^.....^...^.^.^.^.............................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '............................................^.^...^.....^.^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^.^............................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...........................................^...^.^.^.^.^.^.....^...........^.^...^...^.^.^.^.....^...........................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '..........................................^.^.....^.^.....^.....^.....^...^.^...^...^.^.^.^.^...^.^..........................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.........................................^.....^.^.^...^.^.^.^.^.^.^.....^...^.^.^...^.^.^.^.^.^.^.^.........................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '........................................^...^.^.^...^.^.^.^.^.....^.^.^.^.^...^...^.......^.^.^.^...^........................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.......................................^...^.^.^...^...^.^...^.^.^.^...^.....^.....^...^.^.^.^.^.^.^.^.......................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '......................................^.^.^.^.^.^.^.^.^.^...^...^...^.^.^.^.^.^.^.^.^...^.^.^.^...^.^.^......................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.....................................^.^.^...^.^.^.^.^.^.^.^...^.^...^.^...^.^.....^...^.....^.^...^.^.^.....................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '....................................^.^.^.^.^.^.^.......^...^.^.^.^.^.^.^.^.^.^.....^.^.^...^.^.^.^.^.^.^....................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...................................^.^.....^...^...^.^.^.^.^...^.^.^.....^.^...^...^.^.........^...^.^.^.^...................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '..................................^.^.^.....^.^.^.........^.^.^.^...^.......^...^.^.^.^.^.......^.^.^...^.^..................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.................................^.....^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.^.....^.^...^.^.^.^.^.^.^.^.^.^...^.................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '................................^.^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^...^.^.^...^.^.^.^.^.^.^.^...^.^.^.^................................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...............................^...^.^.....^.........^...^.....^.^.^...^.^.....^.....^.^.^.^.^...^.^.^.^.^.^.^...............................'
   dc.b  '.............................................................................................................................................'
   dc.b  '..............................^...^.....^.^.^.^...^.^.^.^.....^.^.^...^...^...^...^.....^.^.^.^.^.^.^.^.^.....^..............................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.............................^.^...^.^...^.^.^.^.^.^.^.^...^.....^.^...^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^...^.^.............................'
   dc.b  '.............................................................................................................................................'
   dc.b  '............................^...^.^.^...^.^.^.^.^.^.^.^...^.^...^.^.^...^.^...^.^.^.^.^.^.^.^.^.......^...^.^.^.^............................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...........................^.....^...^...^.^.^.^.^.^.^...^.^.........^.^.^.^.^.^.^.^.^.^...^.^.^.^...^.....^.^.^.^...........................'
   dc.b  '.............................................................................................................................................'
   dc.b  '..........................^.^.^...^.^.^.^.^.....^...^.^.^...^...^.^.^.^...^.^.^...^.^.^.^.....^.^.....^...^.^.^.^.^..........................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.........................^.^.........^.^.....^.^.....^.....^...^.^...^.^...^.^.....^.^.^...^.^.^...^.^...^.^.^...^.^.........................'
   dc.b  '.............................................................................................................................................'
   dc.b  '........................^.^.^...^.^.^.^.....^.^.^.....^...^.^.^...^.^.^.....^.^.^...^.^.^.^.....^.^.^...^.^.^.^.^...^........................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.......................^...^.^...^.^.^.^.......^.^.^.....^.^.^.^.^.....^.^.^.^.....^.^.^.^.^...^...^.^.^...^...^.^.^.^.......................'
   dc.b  '.............................................................................................................................................'
   dc.b  '......................^.^...^.^...^.^.^.^...^...^...^.^.^.^...^.^.^...^...^...^.^.^.^.......^.^...^...^.^...^.^...^.^.^......................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.....................^.^.^.^.^.^...^.^.^.^.^.^.^.....^.^...^.^.^.^...^.^.^.^...^.^.^...^.^...^.........^.....^.^...^.^.^.....................'
   dc.b  '.............................................................................................................................................'
   dc.b  '....................^.^.^.^...^...^.^...^...^...^.^...^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.....^...^...^...^...^.^.^.......^....................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...................^...^.^.^.^.^.^.....^.^...^...^.^.^.........^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.......^.^.^.......^...................'
   dc.b  '.............................................................................................................................................'
   dc.b  '..................^.......^...^...^.^.^.^...^.........^...^.^.^.....^.......^...^...^.....^.^.^.^.^.^.^.^...^.^...^.^.^.^.^..................'
   dc.b  '.............................................................................................................................................'
   dc.b  '.................^.^.^.^.^.^.^.^.^.....^.^...^.^.^.^...^.^.^...^.^.^...^...^.^...^.^.^.^.^.^.....^.^.^.^.^...^.....^.^...^.^.................'
   dc.b  '.............................................................................................................................................'
   dc.b  '................^.^.^.^.^.^.^...^...^.^.^.^...^.....^.^.^...^.^.^.....^.^.^.....^.^...^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^...^................'
   dc.b  '.............................................................................................................................................'
   dc.b  '...............^.^.....^.^.^.^.^.......^.^.^.^.^.^.^...^.^.^.......^.^...^.^...^.^.^.^...^...^.^.^.^...^.^.^...^.^.^.^.....^.^...............'
   dc.b  '.............................................................................................................................................'
   dc.b  '..............^...^...^.^.^.^.^.....^.^...^.^.^.^.^.^.^.^...^.....^...^.^.^.....^.^.^.^.....^.^...^.^.^.^.^.^.^.....^.^...^.^.^..............'
   dc.b  '.............................................................................................................................................'
   dc.b  '.............^.^.....^.^.^.^.^...^.....^.^.....^.^.^.^...^.^.........^.....^.....^.^...^...^.^.^...^.^.....^.^.^...^.^.^.^.^.^.^.............'
   dc.b  '.............................................................................................................................................'
   dc.b  '............^.^...^...^.^.........^.^.^...^.^.^.^.^.^.....^.^...^.^.........^.^...^.....^.^.....^...^.^.^.^.^.^.^.....^.^...^.^.^............'
   dc.b  '.............................................................................................................................................'
   dc.b  '...........^...^...^...^.^.^...^...^...^.^.^.^...^.....^...^.^.^.....^.....^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^.......^.^...........'
   dc.b  '.............................................................................................................................................'
   dc.b  '..........^...^.^...^...^.^.....^...^.^...^.^.^.....^.^.^.^...^.^...^.^.^.^...^...^...^...^.^.^.^.^.^.^...^.^.^.^.....^...^.^.^.^.^..........'
   dc.b  '.............................................................................................................................................'
   dc.b  '.........^.^...^.^.^.^...^...^...........^.^...^...^.^...^.^.^.^...^.^.^.^.....^.^.....^.^.^.^...^.^.^.....^...^.^.^.^.^.^.^.^.^...^.........'
   dc.b  '.............................................................................................................................................'
   dc.b  '........^...^.^...^.^...^...^.^.^.^.^.^...^.^.....^.^.^.....^.^...^.^.^.....^.....^.^.^.^.^...^.....^...^...^.^.^...^...^...^...^...^........'
   dc.b  '.............................................................................................................................................'
   dc.b  '.......^.^.....^...^.^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.......^.^.^.^.^.^.........^...^.^.^.^.........^.^.^.^.^.....^.^.^.^.^.....^.^.^.......'
   dc.b  '.............................................................................................................................................'
   dc.b  '......^...^.^.^...^.^.^.^...^.^...^...^.^.^.....^.^.^...^.....^.^.^...^.^.^.....^.^.^.^.^.^.^.^.....^.^.......^.^.^.^.^.^.^.^...^.^...^......'
   dc.b  '.............................................................................................................................................'
   dc.b  '.....^.^.......^.^.^.^.^.^...^.^.^...........^.^...^...^.^...^.......^.^.....^...^...^.^.^.....^.^...^...^.^.....^.^.^.^.^.^.^...^.....^.....'
   dc.b  '.............................................................................................................................................'
   dc.b  '....^.^.^.^.^.^...^.^...^...........^.....^...^...^.^.^.^.^.^...^.....^.^...^.^.^...^.^...^...^.^.^...^.^...^.^.^...^.^...^...^.^.^.^...^....'
   dc.b  '.............................................................................................................................................'
   dc.b  '...^.^...^.^.^.^.^.^.^...^.^.^.^...^.^...^.....^.^.^.^...^.^.....^.^.^.^.^...^.^...^.....^...^...^.....^.^...^.^.........^.^.^...^.^.^.^.^...'
   dc.b  '.............................................................................................................................................'
   dc.b  '..^.^.^.....^.^.^.^.^...^.^.^.....^.^.^.^.^.^.^...^.....^.^.....^.^.....^.^...^.......^.^...^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^..'
   dc.b  '.............................................................................................................................................'
   dc.b  '.^.^.^.........^.^.^.....^.^.^.^.^...^.^...^...^.^.^.^.....^...^.^...^.^.^...^.^.....^.....^...^...^...^.^.....^...^.^...^.^.....^.^.^.^.^.^.'
   dc.b  '.............................................................................................................................................'